<html>
	<head>
		<title>Portal Open Stats</title>
		<link rel="stylesheel" href="jquery-ui-1.12.1/jquery-ui.css">

		<script language="JavaScript" src="plotly-1.48.3/plotly-latest.min.js"></script>
		<script language="JavaScript" src="jquery-ui-1.12.1/external/jquery/jquery.js"></script>
		<script language="JavaScript" src="jquery-ui-1.12.1/jquery-ui.js"></script>
		<script language="JavaScript">
			var portalOpenStatsURL = "https://api.shackspace.de/v1/stats/portal";
			var portalOpenStatsData;

			/*
			 * group open-stats using the granularity of the given rounding function
			 */
			function groupBy(openStatsData, dateRoundFunction) {
				var data = { x: new Array(), y: new Array() };

				var yValue = 0;
				var xValue = null;

				for (var i in openStatsData) {
					var element = openStatsData[i];
					var dateValue = dateRoundFunction( new Date( element.time ) );

					if (xValue == null || xValue.getTime() != dateValue.getTime()) {
						if (xValue != null) {
							data.x.push(xValue);
							data.y.push(yValue);
						}

						yValue = 0;
						xValue = dateValue;
					}

					yValue += element.mean*1;
				}

				if (xValue != null) {
					data.x.push(xValue);
					data.y.push(yValue);
				}

				return data;
			}

			/*
			 *	accumulate opening hours per week day
			 */
			function accumulateByWeekdays(openStatsData) {
				var data = { x: new Array(), y: new Array() };

				data.x.push("Monday"); data.y.push(0);
				data.x.push("Tuesday"); data.y.push(0);
				data.x.push("Wednesday"); data.y.push(0);
				data.x.push("Thursday"); data.y.push(0);
				data.x.push("Friday"); data.y.push(0);
				data.x.push("Saturday"); data.y.push(0);
				data.x.push("Sunday"); data.y.push(0);

				for (var i in openStatsData) {
					var element = openStatsData[i];
					var dateValue = new Date(element.time);

					var dayOfWeek = dateValue.getDay();
					data.y[dayOfWeek] += element.mean*1;
				}

				return data;
			}

			/*
			 *	accumulate opening hours per day time
			 */
			function accumulateByHours(openStatsData) {
				var data = { x: new Array(), y: new Array() };

				for (var i=0; i<24; i++) {
					data.x.push(i + ":00");
					data.y.push(0);
				}

				for (var i in openStatsData) {
					var element = openStatsData[i];
					var dateValue = new Date(element.time);

					var hours = dateValue.getHours();
					data.y[hours] += element.mean*1;
				}

				return data;
			}

			function filterGreaterThanDate(element, date) {
				return new Date(element.time) >= date;
			}

			function roundToDate(date) {
				var d = roundToHour(date);
				d.setHours(0);

				return d;
			}

			function roundToMonth(date) {
				var d = roundToDate(date);
				d.setDate(1);
				
				return d;
			}

			function roundToHour(date) {
				var d = new Date(date.getTime());
				d.setMinutes(0);
				d.setSeconds(0);
				d.setMilliseconds(0);

				return d;
			}

			function initGroupByMonthPlot(openStatsData, divName) {
				var data = groupBy(openStatsData, roundToMonth);
				data['type'] = 'bar';

				Plotly.newPlot(
					divName,
					[ data ]
				);
			}

			function initGroupByDatePlot(openStatsData, divName) {
				var data;
				data = groupBy(openStatsData, roundToDate);
				data['type'] = 'bar';
				
				Plotly.newPlot(
					divName,
					[ data ],
					{ xaxis: { tickformat: '%a, %Y-%m-%d' } }
				);
			}

			function initGroupByWeekdayPlot(openStatsData, divName) {
				var data = groupBy(openStatsData, roundToHour);
				data['type'] = 'scatter';
				data['line'] = { shape: 'spline' };

				Plotly.newPlot(
					divName,
					[ data ],
					{ xaxis: { tickformat: '%a, %Y-%m-%d %H:%M' } }
				);
			}

			function initAccumulateByWeekdaysPlot(openStatsData, divName) {
				var data = accumulateByWeekdays(openStatsData);
				data['type'] = 'bar';

				Plotly.newPlot(
					divName,
					[ data ]
				);
			}

			function initAccumulateByHoursPlot(openStatsData, divName) {
				var data = accumulateByHours(openStatsData);
				data['type'] = 'bar';

				Plotly.newPlot(
					divName,
					[ data ]
				);
			}

			/*
			 * initializes plots using plotly lib
			 * parameter openStatsData: parsed JSON of http://api.shackspace.de/v1/stats/portal
			 * 	is expected to be an object like 
			 *	[ 
			 *		{ time: "1970-01-01T00:00:00", mean: "0" }, 
			 *		{ time: "1970-01-01T01:00:00", mean: "1" },
			 *		...
			 *	]
			 */
			function initAllPlots(openStatsData) {
				var dateMaxElement = openStatsData.reduce(
						(max, element) => {
							var elementDate = new Date(element.time);
							var maxDate = new Date(max.time);

							if (elementDate > maxDate)
								return element;

							return max;
						} );
				var dateMax = new Date(dateMaxElement.time).getTime();

				var last14Days = new Date(dateMax - 1000*60*60*24*14)
				var lastMonth = new Date(dateMax - 1000*60*60*24*31)
				var lastYear = new Date(dateMax - 1000*60*60*24*365)

				initGroupByMonthPlot(
					openStatsData.filter( x => filterGreaterThanDate(x, lastYear) ), 
					'lastYear'
				);

				initGroupByDatePlot(
					openStatsData.filter( x => filterGreaterThanDate(x, lastMonth) ), 
					'lastMonth'
				);

				initGroupByWeekdayPlot(
					openStatsData.filter( x => filterGreaterThanDate(x, last14Days) ),
					'lastWeeks'
				);

				initAccumulateByWeekdaysPlot(
					openStatsData.filter( x => filterGreaterThanDate(x, lastMonth) ),
					'daily'
				);

				initAccumulateByHoursPlot(
					openStatsData.filter( x => filterGreaterThanDate(x, last14Days) ),
					'hourly'
				);
			}

			function loadData(url, onLoadEventHandler) {
				var xreq = new XMLHttpRequest();
				xreq.open("GET", url, true);
				xreq.addEventListener("load", onLoadEventHandler);
				xreq.send();
			}

			/*
			 * load portal open stats data and intialize plots
			 */
			function onLoad() {
				loadData(
					portalOpenStatsURL, 
					function() {
						portalOpenStatsData = JSON.parse(this.responseText);
						initAllPlots(portalOpenStatsData); 
					}
				); 
			}

			/*
			 * This method can be called by the developer while debugging
			 * to initialize plots with test data
			 */
			function loadDebugData() {
				var debugScript = document.createElement("script");
				debugScript.setAttribute("language", "JavaScript");
				debugScript.setAttribute("src", "api.shackspace.v1.stats.portal.debugdata.js");

				window.document.head.appendChild(debugScript);
			} 

		</script>
	</head>

	<body onLoad="onLoad()">
		<script language="JavaScript">
			// dirty hack to bypass Same Origin Policy preventing the XMLHttpRequest to succeed
			document.write('<iframe src="' + portalOpenStatsURL + '" style="display:none"></iframe>');
		</script>
		<h2>Opening hours history</h2>
		<h3>last year</h3>
		<div id="lastYear" style="width:80%;height:50%;"></div>
		<h3>last month</h3>
		<div id="lastMonth" style="width:80%;height:50%;"></div>
		<h3>last two weeks</h3>
		<div id="lastWeeks" style="width:80%;height:50%;"></div>

		<h2>Accumulated opening hours</h2>
		<h3>per weekday</h3>
		<div id="daily" style="width:80%;height:50%;"></div>
		<h3>per daytime</h3>
		<div id="hourly" style="width:80%;height:50%;"></div>
	</body>
</html>
