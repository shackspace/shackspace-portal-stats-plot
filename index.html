<html>
	<head>
		<title>Portal Open Stats</title>
		<link rel="stylesheet" href="jquery-ui-1.12.1/jquery-ui.css">
		<link rel="stylesheet" href="jquery-ui-1.12.1/jquery-ui.theme.css">

		<script language="JavaScript" src="plotly-1.48.3/plotly-latest.min.js"></script>
		<script language="JavaScript" src="jquery-ui-1.12.1/external/jquery/jquery.js"></script>
		<script language="JavaScript" src="jquery-ui-1.12.1/jquery-ui.js"></script>
		<script language="JavaScript">
			var portalOpenStatsURL = "https://api.shackspace.de/v1/stats/portal";
			var portalOpenStatsData;

			/*
			 * group open-stats using the granularity of the given rounding function
			 */
			function groupBy(openStatsData, dateRoundFunction) {
				var data = { x: new Array(), y: new Array() };

				var yValue = 0;
				var xValue = null;

				for (var i in openStatsData) {
					var element = openStatsData[i];
					var dateValue = dateRoundFunction( new Date( element.time ) );

					if (xValue == null || xValue.getTime() != dateValue.getTime()) {
						if (xValue != null) {
							data.x.push(xValue);
							data.y.push(yValue);
						}

						yValue = 0;
						xValue = dateValue;
					}

					yValue += element.mean*1;
				}

				if (xValue != null) {
					data.x.push(xValue);
					data.y.push(yValue);
				}

				return data;
			}

			/*
			 *	accumulate opening hours per week day
			 */
			function accumulateByWeekdays(openStatsData) {
				var data = { x: new Array(), y: new Array() };

				data.x.push("Monday"); data.y.push(0);
				data.x.push("Tuesday"); data.y.push(0);
				data.x.push("Wednesday"); data.y.push(0);
				data.x.push("Thursday"); data.y.push(0);
				data.x.push("Friday"); data.y.push(0);
				data.x.push("Saturday"); data.y.push(0);
				data.x.push("Sunday"); data.y.push(0);

				for (var i in openStatsData) {
					var element = openStatsData[i];
					var dateValue = new Date(element.time);

					var dayOfWeek = dateValue.getDay();
					data.y[dayOfWeek] += element.mean*1;
				}

				return data;
			}

			/*
			 *	accumulate opening hours per day time
			 */
			function accumulateByHours(openStatsData) {
				var data = { x: new Array(), y: new Array() };

				for (var i=0; i<24; i++) {
					data.x.push(i + ":00");
					data.y.push(0);
				}

				for (var i in openStatsData) {
					var element = openStatsData[i];
					var dateValue = new Date(element.time);

					var hours = dateValue.getHours();
					data.y[hours] += element.mean*1;
				}

				return data;
			}

			function filterGreaterThanDate(element, date) {
				return new Date(element.time) >= date;
			}

			function filterWeekendDays(element, date) {
				return new Date(element.time).getDay() > 5;
			}

			function roundToHour(date) {
				var d = new Date(date.getTime());
				d.setMinutes(0);
				d.setSeconds(0);
				d.setMilliseconds(0);

				return d;
			}

			function roundToDate(date) {
				var d = roundToHour(date);
				d.setHours(0);

				return d;
			}

			function roundToMonth(date) {
				var d = roundToDate(date);
				d.setDate(1);
				
				return d;
			}

			function roundToYear(date) {
				var d = roundToMonth(date);
				d.setMonth(0);

				return d;
			}

			function initGroupByYearPlot(openStatsData, divName) {
				var data = groupBy(openStatsData, roundToYear);
				data['type'] = 'bar';

				Plotly.newPlot(
					divName,
					[ data ],
					{ xaxis: { tickformat: '%Y' } }
				);
			}

			function initGroupByMonthPlot(openStatsData, divName) {
				var data = groupBy(openStatsData, roundToMonth);
				data['type'] = 'bar';

				Plotly.newPlot(
					divName,
					[ data ]
				);
			}

			function initGroupByDatePlot(openStatsData, divName) {
				var data;
				data = groupBy(openStatsData, roundToDate);
				data['type'] = 'bar';
				
				Plotly.newPlot(
					divName,
					[ data ],
					{ xaxis: { tickformat: '%a, %Y-%m-%d' } }
				);
			}

			function initGroupByWeekdayPlot(openStatsData, divName) {
				var data = groupBy(openStatsData, roundToHour);
				data['type'] = 'scatter';
				data['line'] = { shape: 'spline' };

				Plotly.newPlot(
					divName,
					[ data ],
					{ xaxis: { tickformat: '%a, %Y-%m-%d %H:%M' } }
				);
			}

			function initAccumulateByWeekdaysPlot(openStatsData, divName) {
				var data = accumulateByWeekdays(openStatsData);
				data['type'] = 'bar';

				Plotly.newPlot(
					divName,
					[ data ]
				);
			}

			function initAccumulateByHoursPlot(openStatsData, divName) {
				var data = accumulateByHours(openStatsData);
				data['type'] = 'bar';

				Plotly.newPlot(
					divName,
					[ data ]
				);
			}

			/*
			 * initializes plots using plotly lib
			 * parameter openStatsData: parsed JSON of http://api.shackspace.de/v1/stats/portal
			 * 	is expected to be an object like 
			 *	[ 
			 *		{ time: "1970-01-01T00:00:00", mean: "0" }, 
			 *		{ time: "1970-01-01T01:00:00", mean: "1" },
			 *		...
			 *	]
			 */
			function initAllPlots(openStatsData) {
				var dateMaxElement = openStatsData.reduce(
						(max, element) => {
							var elementDate = new Date(element.time);
							var maxDate = new Date(max.time);

							if (elementDate > maxDate)
								return element;

							return max;
						} );
				var dateMax = new Date(dateMaxElement.time).getTime();

				var last14Days = new Date(dateMax - 1000*60*60*24*14)
				var lastMonth = new Date(dateMax - 1000*60*60*24*31)
				var lastYear = new Date(dateMax - 1000*60*60*24*365)

				initGroupByYearPlot(
					openStatsData,
					'groupByYear'
				);

				initGroupByMonthPlot(
					openStatsData.filter( x => filterGreaterThanDate(x, lastYear) ), 
					'groupByMonth'
				);

				initGroupByDatePlot(
					openStatsData.filter( x => filterGreaterThanDate(x, lastMonth) ), 
					'groupByDate'
				);

				initGroupByWeekdayPlot(
					openStatsData.filter( x => filterGreaterThanDate(x, last14Days) ),
					'groupByHour'
				);

				initAccumulateByWeekdaysPlot(
					openStatsData.filter( x => filterGreaterThanDate(x, lastMonth) ),
					'accumulatedByWeekday'
				);

				initAccumulateByHoursPlot(
					openStatsData
						.filter( x => filterGreaterThanDate(x, last14Days) )
						.filter( x => !filterWeekendDays(x) ),
					'accumulatedByDaytimeAtWorkingDays'
				);

				initAccumulateByHoursPlot(
					openStatsData
						.filter( x => filterGreaterThanDate(x, last14Days) )
						.filter( x => filterWeekendDays(x) ),
					'accumulatedByDaytimeAtWeekend'
				);
			}

			function loadData(url, onLoadEventHandler) {
				var xreq = new XMLHttpRequest();
				xreq.open("GET", url, true);
				xreq.addEventListener("load", onLoadEventHandler);
				xreq.send();
			}

			/*
			 * load portal open stats data and intialize plots
			 */
			function onLoad() {
				loadData(
					portalOpenStatsURL, 
					function() {
						portalOpenStatsData = JSON.parse(this.responseText);
						initAllPlots(portalOpenStatsData);

						$('#mainTabs').tabs();
						$('#openHoursTabs').tabs();
						$('#accumulatedTabs').tabs();
					}
				);
			}

			/*
			 * This method can be called by the developer while debugging
			 * to initialize plots with test data
			 */
			function loadDebugData() {
				var debugScript = document.createElement("script");
				debugScript.setAttribute("language", "JavaScript");
				debugScript.setAttribute("src", "api.shackspace.v1.stats.portal.debugdata.js");

				window.document.head.appendChild(debugScript);
			} 

		</script>
	</head>

	<body onLoad="onLoad()">
		<script language="JavaScript">
			// dirty hack to bypass Same Origin Policy preventing the XMLHttpRequest to succeed
			document.write('<iframe src="' + portalOpenStatsURL + '" style="display:none"></iframe>');
		</script>
		<div id="mainTabs">
			<ul>
				<li><a href="#accumulated">accumulated</a></li>
				<li><a href="#history">history</a></li>
			</ul>
			<div id="accumulated">
				<div id="accumulatedTabs">
					<ul>
						<li><a href="#accumulatedByWeekday">per day of week</a>
						<li><a href="#accumulatedByDaytimeAtWorkingDays">per time of day at working days</a>
						<li><a href="#accumulatedByDaytimeAtWeekend">per time of day at weekends</a>
					</ul>
					<div id="accumulatedByWeekday"></div>
					<div id="accumulatedByDaytimeAtWorkingDays"></div>
					<div id="accumulatedByDaytimeAtWeekend"></div>
				</div>
			</div>
			<div id="history">
				<div id="openHoursTabs">
					<ul>
						<li><a href="#groupByYear">per year</a></li>
						<li><a href="#groupByMonth">per month</a></li>
						<li><a href="#groupByDate">per day</a></li>
						<li><a href="#groupByHour">per daytime</a></li>
					</ul>
					<div id="groupByYear"></div>
					<div id="groupByMonth"></div>
					<div id="groupByDate"></div>
					<div id="groupByHour"></div>
				</div>
			</div>
		</div>
	</body>
</html>
